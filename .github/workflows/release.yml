name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@f4d14e03ff726c06358e5557344e1da148b56cf7 # v1
        with:
          bun-version: "1.3"

      - name: Cache dependencies
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install

      - name: Build all actions
        run: bun run build

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit built files to release tag
        run: |
          # Add the built files for all actions using the discover script
          ACTION_DIRS=$(./scripts/discover-actions.sh)

          for ACTION_NAME in $ACTION_DIRS; do
            git add -f "$ACTION_NAME/dist/"
          done

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            # Commit the built files
            git commit -m "Add built files for release ${{ steps.get_version.outputs.VERSION }}"
            
            # Update the tag to point to the new commit with built files
            git tag -f ${{ steps.get_version.outputs.VERSION }}
            git push origin ${{ steps.get_version.outputs.VERSION }} --force
          fi

      - name: Extract changelog
        id: changelog
        run: |
          # Extract changelog using the dedicated script
          CHANGELOG=$(bun scripts/extract-changelog.ts "${{ steps.get_version.outputs.VERSION }}")

          # Write multiline output without breaking markdown formatting
          {
            echo "CHANGELOG<<'EOF'"
            echo "${CHANGELOG}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Generate action list
        id: action_list
        run: |
          ACTION_LIST=$(./scripts/generate-action-list.sh)
          {
            echo "ACTION_LIST<<'EOF'"
            echo "${ACTION_LIST}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create Release
        uses: actions/create-release@0cb9c9b65d5d1901c1f53e5e66eaf4afd303e70e # v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.get_version.outputs.VERSION }}
          release_name: Release ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## Changes
            ${{ steps.changelog.outputs.CHANGELOG }}

            ## Available Actions
            ${{ steps.action_list.outputs.ACTION_LIST }}
            _Generated from action metadata via `./scripts/generate-action-list.sh`._

            ## Installation Example (iac-risk-analysis)
            ```yaml
            - uses: averlon-security/averlon-terraform-action/iac-risk-analysis@${{ steps.get_version.outputs.VERSION }}
              with:
                api-key: ${{ secrets.AVERLON_API_KEY }}
                api-secret: ${{ secrets.AVERLON_API_SECRET }}
                repo-name: ${{ github.repository }}
                base-commit-hash: ${{ github.event.pull_request.base.sha }}
                head-commit-hash: ${{ github.event.pull_request.head.sha }}
                base-plan-path: './base-plan.json'
                head-plan-path: './head-plan.json'
                base-graph-path: './base-graph.dot'
                head-graph-path: './head-graph.dot'
                comment-on-pr: true
                github-token: ${{ secrets.GITHUB_TOKEN }}
            ```
          draft: true
          prerelease: false
