name: Helm Analysis with Averlon

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]

jobs:
  k8s-analysis:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install yq
        run: |
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq
      
      - name: Generate Helm manifests and convert to JSON
        run: |
          # Run helm install with dry-run to generate manifests
          helm install my-release ./charts/my-app \
            --namespace production \
            --values values.yaml \
            --dry-run --debug > dry-run-output.txt
          
          # Extract the MANIFEST section and convert to JSON
          # This extracts everything after "MANIFEST:" line
          sed -n '/^MANIFEST:/,$p' dry-run-output.txt | \
            tail -n +2 | \
            yq eval -o=json '.' - | \
            jq -s '.' > manifests.json
      
      - name: Analyze with Averlon
        uses: averlon-ai/actions/k8s-analysis@v1
        with:
          api-key: ${{ secrets.AVERLON_API_KEY }}
          api-secret: ${{ secrets.AVERLON_API_SECRET }}
          base-url: https://wfe.dev.averlon.io/
          github-token: ${{ secrets.GITHUB_TOKEN }}
          manifest-file: manifests.json
          cloud-id: ${{ secrets.AWS_ACCOUNT_ID }}
          namespace: production
          release-name: my-release
          filters: Critical,High

  # Example: Multiple environments
  k8s-analysis-multi-env:
    strategy:
      matrix:
        environment: [dev, staging, prod]
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install yq
        run: |
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq
      
      - name: Generate manifests for ${{ matrix.environment }}
        run: |
          helm install my-app-${{ matrix.environment }} ./charts/my-app \
            --namespace ${{ matrix.environment }} \
            --values values-${{ matrix.environment }}.yaml \
            --dry-run --debug | \
            sed -n '/^MANIFEST:/,$p' | \
            tail -n +2 | \
            yq eval -o=json '.' - | \
            jq -s '.' > manifests.json
      
      - name: Analyze ${{ matrix.environment }}
        uses: averlon-ai/actions/k8s-analysis@v1
        with:
          api-key: ${{ secrets.AVERLON_API_KEY }}
          api-secret: ${{ secrets.AVERLON_API_SECRET }}
          base-url: https://wfe.dev.averlon.io/
          github-token: ${{ secrets.GITHUB_TOKEN }}
          manifest-file: manifests.json
          namespace: ${{ matrix.environment }}
          filters: Critical,High,Medium

  # Example: With GitHub Copilot auto-fix
  k8s-analysis-with-copilot:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install yq
        run: |
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq
      
      - name: Generate manifests
        run: |
          helm install my-app ./charts/my-app \
            --values values.yaml \
            --dry-run --debug | \
            sed -n '/^MANIFEST:/,$p' | \
            tail -n +2 | \
            yq eval -o=json '.' - | \
            jq -s '.' > manifests.json
      
      - name: Analyze and Auto-fix with Copilot
        uses: averlon-ai/actions/k8s-analysis@v1
        with:
          api-key: ${{ secrets.AVERLON_API_KEY }}
          api-secret: ${{ secrets.AVERLON_API_SECRET }}
          base-url: https://wfe.dev.averlon.io/
          github-token: ${{ secrets.COPILOT_PAT }}  # PAT with Copilot access enables auto-assignment
          manifest-file: manifests.json
          filters: Critical,High
